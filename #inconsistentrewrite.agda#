module inconsistentrewrite where

data _â‰¡_ {a} {A : Set a} (x : A) : A â†’ Set a where
  refl : x â‰¡ x

{-# BUILTIN EQUALITY _â‰¡_ #-}
{-# BUILTIN REFL refl #-}

module AVL-ish
  { ğ‘¼âŸ¨KeyâŸ© ğ‘¼âŸ¨ValueâŸ© }
  { Key : Set ğ‘¼âŸ¨KeyâŸ© }
  ( Value : Key â†’ Set ğ‘¼âŸ¨ValueâŸ© )
  where

  open import Agda.Primitive using ( _âŠ”_ )
    
  record Î£ {a b} (A : Set a) (B : A â†’ Set b) : Set (a âŠ” b) where
    constructor _,_
    field
      projâ‚ : A
      projâ‚‚ : B projâ‚
   
  open Î£
   
  KV : Set (ğ‘¼âŸ¨KeyâŸ© âŠ” ğ‘¼âŸ¨ValueâŸ©)
  KV = Î£ Key Value

  data Tree : Set (ğ‘¼âŸ¨KeyâŸ© âŠ” ğ‘¼âŸ¨ValueâŸ©) where
    node : (k : KV) â†’ Tree
           
  data _âˆ¼_âˆˆ_ ( k : Key ) ( v : Value k ) : Tree â†’ Set ( ğ‘¼âŸ¨KeyâŸ© âŠ” ğ‘¼âŸ¨ValueâŸ© ) where
    here :  k âˆ¼ v âˆˆ node ( k , v )
            
  postulate
    kâ‚â‰¡kâ‚‚ : âˆ€ ( kâ‚ kâ‚‚ : Key ) â†’ kâ‚ â‰¡ kâ‚‚
    âˆˆâ†’vâ‚â‰¡vâ‚‚ : âˆ€ { k } { vâ‚ vâ‚‚ : Value k } â†’ k âˆ¼ vâ‚ âˆˆ node ( k , vâ‚‚ ) â†’ vâ‚ â‰¡ vâ‚‚

  lem : ( tâ‚ : Tree )
        ( tâ‚‚ : Tree )
        ( _ : âˆ€ {k} {v : Value k} â†’ k âˆ¼ v âˆˆ tâ‚ â†’ k âˆ¼ v âˆˆ tâ‚‚ )
        ( _ : âˆ€ {k} {v : Value k} â†’ k âˆ¼ v âˆˆ tâ‚‚ â†’ k âˆ¼ v âˆˆ tâ‚ ) â†’
        Set
  lem ( node ( kâ‚ , vâ‚ ) ) ( node ( kâ‚‚ , vâ‚‚ ) ) tâ‚â†’tâ‚‚ tâ‚‚â†’tâ‚ rewrite kâ‚â‰¡kâ‚‚ kâ‚ kâ‚‚
       -- When the below lines are commented-out, then C-c C-, at goal 0 (below) reports the following types:
          {-
            tâ‚‚â†’tâ‚    : {k : Key} {v : Value k} â†’
                       k âˆ¼ v âˆˆ node (kâ‚‚ , vâ‚‚) â†’ k âˆ¼ v âˆˆ node (kâ‚‚ , vâ‚)
            tâ‚â†’tâ‚‚    : {k : Key} {v : Value k} â†’
                       k âˆ¼ v âˆˆ node (kâ‚‚ , vâ‚) â†’ k âˆ¼ v âˆˆ node (kâ‚‚ , vâ‚‚)
          -}
   
       -- However, uncommenting the below rewrite...
       -- | âˆˆâ†’vâ‚â‰¡vâ‚‚ (tâ‚â†’tâ‚‚ here) -- equivalent to vâ‚‚ â‰¡ vâ‚
       -- ... results in the following types being reported:
          {-
            tâ‚‚â†’tâ‚    : {k : Key} {v : Value k} â†’
                       k âˆ¼ v âˆˆ node (kâ‚‚ , vâ‚‚) â†’ k âˆ¼ v âˆˆ node (kâ‚‚ , vâ‚‚)
            tâ‚â†’tâ‚‚    : {k : Key} {v : Value k} â†’
                       k âˆ¼ v âˆˆ node (kâ‚‚ , vâ‚) â†’ k âˆ¼ v âˆˆ node (kâ‚‚ , vâ‚‚)
          -}
   
       -- The unexpected behavior here is that vâ‚ has been rewritten to vâ‚‚ in tâ‚‚â†’tâ‚ but not in tâ‚â†’tâ‚‚.
       = {!!}
